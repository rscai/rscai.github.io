<h1 id="java-persistence-api">Java Persistence API</h1>

<ul id="markdown-toc">
  <li><a href="#java-persistence-api" id="markdown-toc-java-persistence-api">Java Persistence API</a>    <ul>
      <li><a href="#overview" id="markdown-toc-overview">Overview</a></li>
      <li><a href="#entity" id="markdown-toc-entity">Entity</a>        <ul>
          <li><a href="#single-entity-to-one-table" id="markdown-toc-single-entity-to-one-table">Single entity to one table</a></li>
          <li><a href="#single-entity-to-primary-and-secondary-tables" id="markdown-toc-single-entity-to-primary-and-secondary-tables">Single entity to primary and secondary tables</a>            <ul>
              <li><a href="#composition" id="markdown-toc-composition">Composition</a></li>
              <li><a href="#aggregation" id="markdown-toc-aggregation">Aggregation</a>                <ul>
                  <li><a href="#unidirectional-onetomany" id="markdown-toc-unidirectional-onetomany">Unidirectional OneToMany</a></li>
                  <li><a href="#manytoone" id="markdown-toc-manytoone">ManyToOne</a></li>
                  <li><a href="#bidirectional-onetomany" id="markdown-toc-bidirectional-onetomany">Bidirectional OneToMany</a></li>
                </ul>
              </li>
              <li><a href="#association" id="markdown-toc-association">Association</a></li>
              <li><a href="#inheritance" id="markdown-toc-inheritance">Inheritance</a>                <ul>
                  <li><a href="#single-table-per-class-hierarchy-strategy" id="markdown-toc-single-table-per-class-hierarchy-strategy">Single Table per Class Hierarchy Strategy</a></li>
                  <li><a href="#joined-subclass-strategy" id="markdown-toc-joined-subclass-strategy">Joined Subclass Strategy</a></li>
                  <li><a href="#table-per-concrete-class-strategy" id="markdown-toc-table-per-concrete-class-strategy">Table per concrete Class Strategy</a></li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#entity-operation" id="markdown-toc-entity-operation">Entity Operation</a>        <ul>
          <li><a href="#entitymanager" id="markdown-toc-entitymanager">EntityManager</a></li>
          <li><a href="#entity-instances-life-cycle" id="markdown-toc-entity-instances-life-cycle">Entity Instance’s Life Cycle</a></li>
          <li><a href="#transaction" id="markdown-toc-transaction">Transaction</a></li>
          <li><a href="#entity-listeners-and-callback-methods" id="markdown-toc-entity-listeners-and-callback-methods">Entity Listeners and Callback Methods</a></li>
        </ul>
      </li>
      <li><a href="#query" id="markdown-toc-query">Query</a>        <ul>
          <li><a href="#query-language" id="markdown-toc-query-language">Query Language</a></li>
          <li><a href="#criteria-api" id="markdown-toc-criteria-api">Criteria API</a></li>
        </ul>
      </li>
      <li><a href="#caching" id="markdown-toc-caching">Caching</a></li>
      <li><a href="#appendix" id="markdown-toc-appendix">Appendix</a>        <ul>
          <li><a href="#normal-forms" id="markdown-toc-normal-forms">Normal Forms</a>            <ul>
              <li><a href="#first-normal-form-1nf" id="markdown-toc-first-normal-form-1nf">First Normal Form (1NF)</a></li>
              <li><a href="#second-normal-form-2nf" id="markdown-toc-second-normal-form-2nf">Second Normal Form (2NF)</a></li>
              <li><a href="#third-normal-form-3nf" id="markdown-toc-third-normal-form-3nf">Third Normal Form (3NF)</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#reference" id="markdown-toc-reference">Reference</a></li>
    </ul>
  </li>
</ul>

<h2 id="overview">Overview</h2>

<p>The techincal objective of JPA is to provide an object/relational mapping facility for the Java application developer using a Java domain model to manage a relational database.</p>

<h2 id="entity">Entity</h2>

<blockquote>
  <p>An entity is a lightweight persistent domain object.</p>

  <p>The primary programming artifact is the entity class. An entity class may make use of auxiliary classes that serve as helper classes or that are used to represent the state of the entity.[5]</p>
</blockquote>

<p>JPA is designed to map Object-Oriented model to Relational model, <strong>NOT</strong> map Relational model to Object-Oriented model.</p>

<blockquote>
  <p>The entity class must be annotated with the <code class="language-plaintext highlighter-rouge">Entity</code> annotation or denoted in the XML descriptor  as an entity.[5]</p>
</blockquote>

<p>The <code class="language-plaintext highlighter-rouge">Entity</code> to <code class="language-plaintext highlighter-rouge">Relation</code> mapping could be denoted by XML or Java annotation. Considering of readablity, maintainability and static validation, it recommends describing mapping by Java annotation.</p>

<blockquote>
  <p>The entity  class must have a no-arg constructor. The entity class may have other constructors as well. The no-arg constructor msut be public or protected.[5]</p>

  <p>The persistent state of an entity is accessed by the persistence provider runtime either via JavaBeans style property accessors (“property access”) or via instance variables (“field access”). [5]</p>

  <p>Terminology Note: The persistent fields and properties of an entity class are generically referred to in this document as the “attributes” of the class.[5]</p>
</blockquote>

<p><a href="https://docs.oracle.com/javase/tutorial/javabeans/writing/properties.html">JavaBeans style property accessors</a></p>

<h3 id="single-entity-to-one-table">Single entity to one table</h3>

<p>The simplest entity/table mapping is single entity to one table mapping. All attributes of entity are mapped to columns of one table.</p>

<pre><code class="language-puml">@startuml
class Account &lt;&lt;Entity&gt;&gt; {
    -id: String
    -firstName: String
    -lastName: String
}
@enduml
</code></pre>

<pre><code class="language-puml">@startuml
class ACCOUNT &lt;&lt; (T,ORCHID) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    FIRST_NAME VARCHAR2(100) NOT NULL
    LAST_NAME VARCHAR2(100) NOT NULL
}
@enduml
</code></pre>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ACCOUNT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"FIRST_NAME"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">firstName</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"LAST_NAME"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lastNane</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="single-entity-to-primary-and-secondary-tables">Single entity to primary and secondary tables</h3>

<p>More complex case is that mapping all attributes of entity to columns of more than one.<br />
Considered of database IO tuning, it sometimes split a long table into multiple short tables. For example, entity <code class="language-plaintext highlighter-rouge">Account</code> has five fields, three of them (<code class="language-plaintext highlighter-rouge">id</code>, <code class="language-plaintext highlighter-rouge">firstName</code> and <code class="language-plaintext highlighter-rouge">lastName</code>) are always not empty, another two fields are nullable. If map all of them to one table, it will get a sparse table. Database IO operation will get more inefficient on sparse table. Therefore, it usually is splitted into two tables in practice.</p>

<pre><code class="language-puml">@startuml
class Account &lt;&lt;Entity&gt;&gt; {
    -id: String
    -firstName: String
    -lastName: String
    -telphone: String
    -address: String
}
@enduml
</code></pre>

<pre><code class="language-puml">@startuml
class ACCOUNT &lt;&lt; (T,orchid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    FIRST_NAME VARCHAR2(100) NOT NULL
    LAST_NAME: VARCHAR2(100) NOT NULL
}
class ACCOUNT_CONTACT &lt;&lt; (T,orchid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    TELPHONE VARCHAR2(20)
    ADDRESS VARCHAR2(1000)
}

ACCOUNT "1" -- "0..1" ACCOUNT_CONTACT
@enduml
</code></pre>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ACCOUNT"</span><span class="o">)</span>
<span class="nd">@SecondaryTable</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ACCOUNT_CONTACT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"FIRST_NAME"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">firstName</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"LAST_NAME"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lastName</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"TELPHONE"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="o">,</span> <span class="n">table</span><span class="o">=</span><span class="s">"ACCOUNT_CONTACT"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">telphone</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ADDRESS"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">1000</span><span class="o">,</span> <span class="n">table</span><span class="o">=</span><span class="s">"ACCOUNT_CONTACT"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">address</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="composition">Composition</h4>

<p>Composition is a common classes relationship. For example, <code class="language-plaintext highlighter-rouge">Account</code> composites <code class="language-plaintext highlighter-rouge">Contact</code>. <code class="language-plaintext highlighter-rouge">Contact</code> is a part of <code class="language-plaintext highlighter-rouge">Account</code>, when <code class="language-plaintext highlighter-rouge">Account</code> destroyed, <code class="language-plaintext highlighter-rouge">Contact</code> has to be destroyed together.</p>

<pre><code class="language-puml">@startuml
class Contact {
    -label: String
    -telphone: String
    -address: String
}
class Account &lt;&lt;Entity&gt;&gt; {
    -id: String
    -firstName: String
    -lastName: String
    -contacts: List&lt;Contact&gt;
}
Account *- Contact
@enduml
</code></pre>

<pre><code class="language-puml">@startuml
class ACCOUNT &lt;&lt; (T,orchid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    FIRST_NAME VARCHAR2(100) NOT NULL
    LAST_NAME: VARCHAR2(100) NOT NULL
}
class ACCOUNT_CONTACT &lt;&lt; (T,orchid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    LABEL VARCHAR2(50) NOT NULL
    TELPHONE VARCHAR2(20)
    ADDRESS VARCHAR2(1000)
}

ACCOUNT "1" -- "0..*" ACCOUNT_CONTACT
@enduml
</code></pre>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Embeddable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Contact</span> <span class="o">{</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"LABEL"</span><span class="o">,</span><span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">label</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"TELPHONE"</span><span class="o">,</span><span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">telphone</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ADDRESS"</span><span class="o">,</span><span class="n">length</span><span class="o">=</span><span class="mi">1000</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">address</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ACCOUNT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span><span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"FIRST_NAME"</span><span class="o">,</span><span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">firstName</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"LAST_NAME"</span><span class="o">,</span><span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lastName</span><span class="o">;</span>
    <span class="nd">@ElementCollection</span>
    <span class="nd">@CollectionTable</span><span class="o">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s">"CONTACT"</span><span class="o">,</span>
        <span class="n">joinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">)</span>
    <span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Contact</span><span class="o">&gt;</span> <span class="n">contacts</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="aggregation">Aggregation</h4>

<p>Unlike composition relationship, entities of aggregation are independent. For example, <code class="language-plaintext highlighter-rouge">Category</code> and <code class="language-plaintext highlighter-rouge">Product</code> are one-to-many relationship, but both of them are independent. When destroyed <code class="language-plaintext highlighter-rouge">Category</code>, it needn’t destroy related <code class="language-plaintext highlighter-rouge">Product</code> together. Correspondingly, when destroyed <code class="language-plaintext highlighter-rouge">Product</code>, needn’t destroy related <code class="language-plaintext highlighter-rouge">Category</code> together.</p>

<h5 id="unidirectional-onetomany">Unidirectional OneToMany</h5>

<pre><code class="language-puml">@startuml
class Category &lt;&lt;Entity&gt;&gt; {
    -id: String
    -name: String
    -products: List&lt;Product&gt;
}
class Product &lt;&lt;Entity&gt;&gt; {
    -id: String
    -subject: String
}
Category o- "products" Product
@enduml
</code></pre>

<pre><code class="language-puml">@startuml
class CATEGORY &lt;&lt; (T,orchid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    NAME VARCHAR2(100) NOT NULL
}
class PRODUCT &lt;&lt; (T,orchid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    SUBJECT VARCHAR2(200) NOT NULL
    CATEGORY_ID VARCHAR2(100) NOT NULL
}
CATEGORY "1" -- "0..*" PRODUCT
@enduml
</code></pre>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PRODUCT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"SUBJECT"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">200</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">subject</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"CATEGORY"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Category</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"NAME"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="nd">@OneToMany</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s">"CATEGORY_ID"</span><span class="o">,</span>
        <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"ID"</span>
        <span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">products</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>JPA 1.0 does not support a unidirectional OneToMany relationship without a JoinTable. Since JPA 2.0 there is a support for unidirectional OneToMany. In JPA 2.x a @JoinColumn can be used on a OneToMany to define the foreign key, some JPA providers may support this already.</p>
</blockquote>

<h5 id="manytoone">ManyToOne</h5>

<pre><code class="language-puml">@startuml
class Category &lt;&lt;Entity&gt;&gt; {
    -id: String
    -name: String
}
class Product &lt;&lt;Entity&gt;&gt; {
    -id: String
    -subject: String
    -category: Category
}
Category "category" -o Product
@enduml
</code></pre>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PRODUCT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"SUBJECT"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">200</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">subject</span><span class="o">;</span>
    <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"CATEGORY_ID"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Category</span> <span class="n">category</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"CATEGORY"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Category</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"NAME"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="bidirectional-onetomany">Bidirectional OneToMany</h5>

<pre><code class="language-puml">@startuml
class Category &lt;&lt;Entity&gt;&gt; {
    -id: String
    -name: String
    -products: List&lt;Product&gt;
}
class Product &lt;&lt;Entity&gt;&gt; {
    -id: String
    -subject: String
    -category: Category
}
Category "category" o- "products" Product
@enduml
</code></pre>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PRODUCT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"SUBJECT"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">200</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">subject</span><span class="o">;</span>
    <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"CATEGORY_ID"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Category</span> <span class="n">category</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"CATEGORY"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Category</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"NAME"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">"category"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">products</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="association">Association</h4>

<pre><code class="language-puml">@startuml
class Collection &lt;&lt;Entity&gt;&gt; {
    -id: String
    -name: String
}
class Product &lt;&lt;Entity&gt;&gt; {
    -id: String
    -subject: String
}
Collection - "products" Product
@enduml
</code></pre>

<pre><code class="language-puml">@startuml
class COLLECTION &lt;&lt; (T,orchid) &gt;&gt; {
    ID VARCHAR2(100) NOT NUL
    NAME VARCHAR2(100) NOT NULL
}
class PRODUCT &lt;&lt; (T,orchid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    SUBJECT VARCHAR2(200) NOT NULL
}
class COLLECTION_PRODUCT_REL &lt;&lt; (T,orchid) &gt;&gt; {
    COLLECTION_ID VARCHAR2(100) NOT NULL
    PRODUCT_ID VARCHAR2(100) NOT NULL
}
COLLECTION "1" -- "*" COLLECTION_PRODUCT_REL
COLLECTION_PRODUCT_REL "*" -- "1" PRODUCT
@enduml
</code></pre>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PRODUCT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"SUBJECT"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">200</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">subject</span><span class="o">;</span>
<span class="o">}</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"COLLECTION"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Collection</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"NAME"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="nd">@ManyToMany</span>
    <span class="nd">@JoinTable</span><span class="o">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s">"COLLECTION_PRODUCT_REL"</span><span class="o">,</span>
        <span class="n">joinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"COLLECTION_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"ID"</span><span class="o">),</span>
        <span class="n">inverseJoinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"PRODUCT_ID"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"ID"</span><span class="o">)</span>
    <span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">products</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>Although a ManyToMany relationship is always bi-directional on the database, the object model can choose if it will be mapped in both directions, and in which direction it will be mapped in. If you choose to map the relationship in both directions, then one direction must be defined as the owner and the other must use the mappedBy attribute to define its mapping. This also avoids having to duplicate the JoinTable information in both places.</p>

  <p>If the mappedBy is not used, then the persistence provider will assume there are two independent relationships, and you will end up getting duplicate rows inserted into the join table. If you have a conceptual bi-directional relationship, but have two different join tables in the database, then you must not use the mappedBy, as you need to maintain two independent tables.</p>

  <p>As with all bi-directional relationships it is your object model’s and application’s responsibility to maintain the relationship in both direction. There is no magic in JPA, if you add or remove to one side of the collection, you must also add or remove from the other side, see object corruption. Technically the database will be updated correctly if you only add/remove from the owning side of the relationship, but then your object model will be out of synch, which can cause issues.[1]</p>
</blockquote>

<h4 id="inheritance">Inheritance</h4>

<pre><code class="language-puml">@startuml
enum DeliveryStatus {
    INIT
    ON_DELIVER
    RECEIVED_AND_SIGNED
    REJECTED
    ON_RETURN
}
abstract class Delivery &lt;&lt;Entity&gt;&gt; {
    #id: String
    #status: DeliveryStatus
}
class CustomDelivery &lt;&lt;Entity&gt;&gt; {
}
class EmailDelivery &lt;&lt;Entity&gt;&gt; {
    -email: String
}
class ExpressDelivery &lt;&lt;Entity&gt;&gt; {
    -vendor: String
    -trackId: String
    -recipient: Contact
}

Delivery &lt;|-- CustomDelivery
Delivery &lt;|-- EmailDelivery
Delivery &lt;|-- ExpressDelivery
@enduml
</code></pre>

<p>There are three basic strategies that are used when mapping a class or class hierarchy to a relational database:</p>

<ul>
  <li>single table per class hierarchy</li>
  <li>joined subclass strategy</li>
  <li>table per concrete entity class</li>
</ul>

<h5 id="single-table-per-class-hierarchy-strategy">Single Table per Class Hierarchy Strategy</h5>

<p>In this strategy, all the classes in a hierarchy are mapped to a single table. The table has a column that servers as a “discriminator column”, that is, a column whose value identifies the specific subclass to which the instance taht is represented by the row belongs.<br />
This mapping strategy provides good support for polymorphic relationships between entities and for queries that range over the class hierarchy.<br />
It has the drawback, however, that it requires that the columns that correspond to state specific to the subclasses be nullable.</p>

<pre><code class="language-puml">@startuml
class DELIVERY &lt;&lt; (T, chid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    STATUS VARCHAR2(50) NOT NULL
    DELIVERY_TYPE VARCHAR2(20) NOT NULL
    EMAIL VARCHAR2(100)
    VENDOR VARCHAR2(100)
    TRACK_ID VARCHAR2(50)
    CONTACT_ID VARCHAR2(100)
}
class CONTACT &lt;&lt; (T, chid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    TELPHONE VARCHAR2(20) NOT NULL
    ADDRESS VARCHAR2(1000) NOT NULL
}
DELIVERY "1" - "0..1" CONTACT
@enduml
</code></pre>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Inheritance</span>
<span class="nd">@DiscriminatorColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"DELIVERY_TYPE"</span><span class="o">)</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"DELIVERY"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Delivery</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"STATUS"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="nc">DeliveryStatus</span> <span class="n">status</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"CUSTOM"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomDelivery</span> <span class="kd">extends</span> <span class="nc">Delivery</span> <span class="o">{</span>

<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"EMAIL"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmailDelivery</span> <span class="kd">extends</span> <span class="nc">Delivery</span> <span class="o">{</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMAIL"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"EXPRESS"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExpressDelivery</span> <span class="kd">extends</span> <span class="nc">Delivery</span> <span class="o">{</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"VENDOR"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">vendor</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"TRACK_ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">trackId</span><span class="o">;</span>
    <span class="nd">@OneToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"CONTACT_ID"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Contact</span> <span class="n">contact</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="joined-subclass-strategy">Joined Subclass Strategy</h5>

<p>In the joined subclass strategy, the root of the class hierarchy is represented by a single table. Each subclass is represented by a separate table that contains those fields that are specific to the subclass (not inherited from its superclass), as well as the column(s) that represent its primary key. The primary key column(s) of the subclass table serves as a foreign key to the primary key of the superclass table.<br />
This strategy provides support for polymorphic relationships between entities.<br />
It has the drawback that it requires that one or more join operations be performed to instantiate instances of a subclass. In deep class hierarchies, this may lead to unacceptable performance. Queries that range over the class hierarchy likewise require joins.</p>

<pre><code class="language-puml">@startuml
class DELIVERY &lt;&lt; (T, chid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    STATUS VARCHAR2(50) NOT NULL
    DELIVERY_TYPE VARCHAR2(20) NOT NULL
}
class CUSTOM_DELIVERY &lt;&lt; (T, chid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
}
class EMAIL_DELIVERY &lt;&lt; (T, chid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    EMAIL VARCHAR2(100) NOT NULL
}
class EXPRESS_DELIVERY &lt;&lt; (T, chid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    VENDOR VARCHAR2(100) NOT NULL
    TRACK_ID VARCHAR2(50) NOT NULL
    CONTACT_ID VARCHAR2(100) NOT NULL
}
DELIVERY "1" -- "0..1" CUSTOM_DELIVERY
DELIVERY "1" -- "0..1" EMAIL_DELIVERY
DELIVERY "1" -- "0..1" EXPRESS_DELIVERY
@enduml
</code></pre>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="nc">InheritanceType</span><span class="o">.</span><span class="na">JOINED</span><span class="o">)</span>
<span class="nd">@DiscriminatorColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"DELIVERY_TYPE"</span><span class="o">)</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"DELIVERY"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Delivery</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"STATUS"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="nc">DeliveryStatus</span> <span class="n">status</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"CUSTOM"</span><span class="o">)</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"CUSTOM_DELIVERY"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomDelivery</span> <span class="kd">extends</span> <span class="nc">Delivery</span> <span class="o">{</span>

<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"EMAIL"</span><span class="o">)</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMAIL_DELIVERY"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmailDelivery</span> <span class="kd">extends</span> <span class="nc">Delivery</span> <span class="o">{</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMAIL"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"EXPRESS"</span><span class="o">)</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EXPRESS_DELIVERY"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExpressDelivery</span> <span class="kd">extends</span> <span class="nc">Delivery</span> <span class="o">{</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"VENDOR"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">vendor</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"TRACK_ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">trackId</span><span class="o">;</span>
    <span class="nd">@OneToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"CONTACT_ID"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Contact</span> <span class="n">contact</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="table-per-concrete-class-strategy">Table per concrete Class Strategy</h5>

<p>In this mapping strategy, each class is mapped to a separate table. All properties of the class, including inherited properties, are mapped to columns of the table for the class.<br />
This trategy has the following drawbacks:</p>

<ul>
  <li>It provides poor support for polymorphic relationships.</li>
  <li>It typically requires that SQL UNION queries (or a separate SQL query per subclass) be issued for queries that are intended to range over the class hierarchy.</li>
</ul>

<pre><code class="language-puml">@startuml
class CUSTOM_DELIVERY &lt;&lt; (T, chid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    STATUS VARCHAR2(50) NOT NULL
}
class EMAIL_DELIVERY &lt;&lt; (T, chid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    STATUS VARCHAR2(50) NOT NULL
    EMAIL VARCHAR2(100) NOT NULL
}
class EXPRESS_DELIVERY &lt;&lt; (T, chid) &gt;&gt; {
    ID VARCHAR2(100) NOT NULL
    STATUS VARCHAR2(50) NOT NULL
    VENDOR VARCHAR2(100) NOT NULL
    TRACK_ID VARCHAR2(50) NOT NULL
    CONTACT_ID VARCHAR2(100) NOT NULL
}
@enduml
</code></pre>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="nc">InheritanceType</span><span class="o">.</span><span class="na">TABLE_PER_CLASS</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Delivery</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"STATUS"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="nc">DeliveryStatus</span> <span class="n">status</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"CUSTOM_DELIVERY"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomDelivery</span> <span class="kd">extends</span> <span class="nc">Delivery</span> <span class="o">{</span>

<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMAIL_DELIVERY"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmailDelivery</span> <span class="kd">extends</span> <span class="nc">Delivery</span> <span class="o">{</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EMAIL"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"EXPRESS_DELIVERY"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExpressDelivery</span> <span class="kd">extends</span> <span class="nc">Delivery</span> <span class="o">{</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"VENDOR"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">vendor</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"TRACK_ID"</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">trackId</span><span class="o">;</span>
    <span class="nd">@OneToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"CONTACT_ID"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Contact</span> <span class="n">contact</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="entity-operation">Entity Operation</h2>

<h3 id="entitymanager">EntityManager</h3>

<blockquote>
  <p>An EntityManager instance is associated with a persistence context. A persistence context is a set of entity instances in which for any persistent entity identity there is a unique entity instance. Within the persistence context, the entity instances and their lifecycle are managed. The <code class="language-plaintext highlighter-rouge">EntityManager</code> interface defines the methods that are used to interact with the persistence context. The <code class="language-plaintext highlighter-rouge">EntityManager</code> API is used to create and remove persistent entity instances, to find persistent entities by primary key, and to query over persistent entities.[5]</p>

  <p>The set of entities that cna be managed by a given <code class="language-plaintext highlighter-rouge">EntityManager</code> instance is defined by a persistence unit. A persistence unit defines the set of all classes that are related or grouped by the application, and which must be colocated in their mapping to a single database.[5]</p>
</blockquote>

<h3 id="entity-instances-life-cycle">Entity Instance’s Life Cycle</h3>

<blockquote>
  <p>An entity instance can be characterized as being new, managed, detached and removed.</p>

  <ul>
    <li>A <code class="language-plaintext highlighter-rouge">new</code> entity instance has no persistent identity, and is not yet associcated with a persistence context.</li>
    <li>A <code class="language-plaintext highlighter-rouge">managed</code> entity instance is an instance with a persistent identity that is currently associated with a persistence context.</li>
    <li>A <code class="language-plaintext highlighter-rouge">detached</code> entity instance is an instance with a persistent identity that is not (or no longer) associated with a persistence context.</li>
    <li>A <code class="language-plaintext highlighter-rouge">removed</code> entity instance is an instance with a persistent identity, assiciated with a persistence context, that will be removed from the database upon transaction commit.[5]</li>
  </ul>
</blockquote>

<pre><code class="language-puml">@startuml
[*]-&gt;new
new--&gt;managed: persist
new-&gt;new: remove
new-&gt;new: detach
managed-&gt;managed: persist
managed-&gt;removed: remove
managed--&gt;detached: detach
removed--&gt;managed: persist
removed-&gt;removed: remove
removed--&gt;detached: detach
detached-&gt;[*]: persist
detached-&gt;[*]: remove
@enduml
</code></pre>

<p>Entity instance starts from state <code class="language-plaintext highlighter-rouge">new</code>, it will transist to state <code class="language-plaintext highlighter-rouge">managed</code> when invoked the <code class="language-plaintext highlighter-rouge">persist</code> method on it or by cascading the persist operation.</p>

<p>When invoked the <code class="language-plaintext highlighter-rouge">remove</code> method on <code class="language-plaintext highlighter-rouge">managed</code> entity instance, it will transist to state <code class="language-plaintext highlighter-rouge">removed</code>. Similarly, when invoked the <code class="language-plaintext highlighter-rouge">detach</code> method on <code class="language-plaintext highlighter-rouge">managed</code> entity instance, it will transist to state <code class="language-plaintext highlighter-rouge">detached</code>.</p>

<p>When invoked the <code class="language-plaintext highlighter-rouge">persist</code> method on <code class="language-plaintext highlighter-rouge">removed</code> entity instance, it will transist to state <code class="language-plaintext highlighter-rouge">managed</code>. If invoked <code class="language-plaintext highlighter-rouge">detach</code> method on entity instance, it will transist to state <code class="language-plaintext highlighter-rouge">detached</code>.</p>

<p><code class="language-plaintext highlighter-rouge">detached</code> is the final state of entity instance. Even it is allowed to invoke <code class="language-plaintext highlighter-rouge">merge</code> method on <code class="language-plaintext highlighter-rouge">detached</code> entity instance, but it is creating new one entityn instance than transisting <code class="language-plaintext highlighter-rouge">detached</code> to another state.</p>

<h3 id="transaction">Transaction</h3>

<p>PersistenceContextType:</p>

<ul>
  <li>TRANSACTION</li>
  <li>EXTENDED</li>
</ul>

<p>SynchronizationType:</p>

<ul>
  <li>SYNCHRONIZED</li>
  <li>UNSYNCHRONIZED</li>
</ul>

<blockquote>
  <p>The managed entities of a transaction-scoped persistence context become detached when the transaction commits; the managed entities of an extended persistence context remain managed.</p>

  <p>For both transaction-scoped persistence contexts and for extended persistence contexts that are joined to the current transction, transaction rollback causes all <code class="language-plaintext highlighter-rouge">pre-existing</code> managed instances and removed instances to become detached. The instances’ state will be the state of the instances at the point at which the transaction was rolled back. Transaction rollback typically causes the persistence context to be in an inconsistent state at the point of rollback. In particular , the state of version attributes and generated state (e.g., generated primary keys) may be inconsistent. Instances that were formerly managed by the persistence context (including new instances that were made persistent in that transaction) may therefore not be reusable in the same manner as other detached objects – for example, they may fail when passed to the merge operation.</p>
</blockquote>

<h3 id="entity-listeners-and-callback-methods">Entity Listeners and Callback Methods</h3>

<p>Entity lifecycle events:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Prepersist</code></li>
  <li><code class="language-plaintext highlighter-rouge">PostPersist</code></li>
  <li><code class="language-plaintext highlighter-rouge">PreRemove</code></li>
  <li><code class="language-plaintext highlighter-rouge">PostRemove</code></li>
  <li><code class="language-plaintext highlighter-rouge">PreUpdate</code></li>
  <li><code class="language-plaintext highlighter-rouge">PostUpdate</code></li>
  <li><code class="language-plaintext highlighter-rouge">PostLoad</code></li>
</ul>

<blockquote>
  <p>Entity lifecycle callback methods can be defined on an entity listener class and/or directly on an entity class or mapped superclass.</p>

  <p>Callback methods defined on an entity class or mapped superclass have the following signature:</p>

  <p><code class="language-plaintext highlighter-rouge">void &lt;METHOD&gt;()</code></p>

  <p>Callback methods defined on an entity listener class have the following signature:</p>

  <p><code class="language-plaintext highlighter-rouge">void &lt;METHOD&gt;(Object)</code></p>

  <p>The <code class="language-plaintext highlighter-rouge">Object</code> argument is the entity instance for which the callback method is invoked. It may be declared as the actual entity type.</p>

  <p>The callback methods can have public, private, protected, or package level access, but must not be <code class="language-plaintext highlighter-rouge">static</code> or <code class="language-plaintext highlighter-rouge">final</code>.[5]</p>

  <p>The following rules apply to lifecycle callback methods:</p>

  <ul>
    <li>Lifecycle callback methods may throw unchecked/runtime exceptions. A runtime exception thrown by a callback method that executes within a transaction causes that transaction to be marked for rollback if the persistence context is joined to the transaction.</li>
    <li>Lifecycle callbacks can invoke JNDI, JDBC, JMS, and enterprise beans.</li>
    <li>In general, the lifecycle method of a portable application should not invoke <code class="language-plaintext highlighter-rouge">EntityManager</code> or query operations, access other entity instances, or modify relationships whithin the same persistence context. A lifecycle method may modify the non-relationship state of the entity on which it is invoked.[5]</li>
  </ul>
</blockquote>

<h2 id="query">Query</h2>

<h3 id="query-language">Query Language</h3>

<blockquote>
  <p>The Java Persistence query language is a string-based query language used to define queries over entities and their persistent state. It enbales the application developer to specify the semantics of queries in a portable way, independent of the particular database schema in use in an enterprise environment. The full range of the langauge may be used in both static and dynamic queries.</p>

  <p>The query language uses the absdtract persistence schema of entities, including their embedded objects and relationships, for its data model, and it defines operators and expressions based on this data model. It uses a SQL-like syntax to select objects or values based on abstract schema types and relationships. It is possible to parse and validate queries before entities are deployed.[5]</p>
</blockquote>

<p>In BNF syntax, a query language statement is defined as:<br />
<code class="language-plaintext highlighter-rouge">QL_statement ::= select_statement|update_statement|delete_statement</code></p>

<p>a select statement is a string which contains of the following clauses:</p>

<ul>
  <li>SELECT, required. Which determines the type of the objects or values to be selected.</li>
  <li>FROM, required. Which declares what domains the query apply on.</li>
  <li>WHERE, optional. Which declares the restrict on the results that retured by the query.</li>
  <li>GROUP BY, optional. Which allows query results to be aggregated in terms of groups.</li>
  <li>HAVING, optional. Which allows filtering over aggregated groups.</li>
  <li>OVER BY, optional. Which declares the order of the returns that returned by the query.</li>
</ul>

<blockquote>
  <p>In BNF syntax, a select statement is defined as:<br />
<code class="language-plaintext highlighter-rouge">select_statement ::= select_clause from_clause [where_clause] [group_clause] [having_clause] [orderby_clause]</code>[5]</p>
</blockquote>

<p>In BNF syntax, a update statement is defined as:<br />
<code class="language-plaintext highlighter-rouge">update_statement ::= update_clause [where_clasue]</code></p>

<p>In BNF syntax, a delete statement is defined as:<br />
<code class="language-plaintext highlighter-rouge">delete_statement ::= delete_clause [where_clause]</code></p>

<h3 id="criteria-api">Criteria API</h3>

<blockquote>
  <p>The Java Persistence Criteria API, like the Java Persistence query language is based on the abstract persistence schema of entities, their embedded objects, and their relationships as its data model. This abstract persistence schema is materialized in the form of metamodel objects over which the Criteria API operates. The semantics of criteria queries are designed to reflect those of Jave Persistence query language queries.</p>

  <p>The syntax of the Criteria API is designed to allow the construction of an object-based query “graph”, whose nodes correspond to the semantic query elements.[5]</p>
</blockquote>

<h2 id="caching">Caching</h2>

<blockquote>
  <p>This specification supports the use of the second-level cache by the persistence provider. The second-level cache, if used, underlies the persistence context, and is largely transparent to the application.</p>

  <p>A second-level cache is typically used to enhance performance. Use of a cache, however, may have consequences in terms of the up-to-dateness of data seen by the application, resulting in “stale reads”. A stale read is defined as the reading of entities or entity state that is older than the point at which the persistence context was started.</p>
</blockquote>

<p>JPA’s caching behavior could be configured y options <code class="language-plaintext highlighter-rouge">shared-cache-mode</code>, <code class="language-plaintext highlighter-rouge">CacheRetriveMode</code> and <code class="language-plaintext highlighter-rouge">CacheStoreMode</code>.</p>

<p><code class="language-plaintext highlighter-rouge">shared-cache-mode</code> options:</p>

<ul>
  <li>ALL</li>
  <li>NONE</li>
  <li>ENABLE_SELECTIVE</li>
  <li>DISABLE_SELECTIVE</li>
  <li>UNSPECIFIED</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">CacheRetriveMode</code> options:</p>

<ul>
  <li>USE</li>
  <li>BYPASS</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">CacheStoreMode</code> options:</p>

<ul>
  <li>USE</li>
  <li>BYPASS</li>
  <li>REFRESH</li>
</ul>

<h2 id="appendix">Appendix</h2>

<h3 id="normal-forms">Normal Forms</h3>

<blockquote>
  <p>Codd introduced the concept of normalization and what is now known as the first normal form (1NF) in 1970. Codd went on to define the second normal form (2NF) and third normal form (3NF) in 1971, and Codd and Raymond F. Boyce defined the Boyce-Codd normal form (BCNF) in 1974.</p>

  <p>Informally, a relational database relation is often described as “normalized” if it meets third normal form.[7] Most 3NF relations are free of insertion, update, and deletion anomalies.</p>

  <p>The normal forms (from least normalized to most normalized) are:</p>

  <ul>
    <li>UNF: Unnormalized form</li>
    <li>1NF: First normal form</li>
    <li>2NF: Second normal form</li>
    <li>3NF: Third normal form</li>
    <li>EKNF: Elementary key normal form</li>
    <li>BCNF: Boyce-Codd normal form</li>
    <li>4NF: Fourth normal form</li>
    <li>ETNF: Essential tuple normal form</li>
    <li>5NF: Fifth normal form</li>
    <li>DKNF: Domain-key normal form</li>
    <li>6NF: Sixth normal form[2]</li>
  </ul>
</blockquote>

<h4 id="first-normal-form-1nf">First Normal Form (1NF)</h4>

<blockquote>
  <p>If normalization as described above is to be applicable, the unnormalized collection of relations must satisfy the following conditions:</p>

  <p>(1) The graph of interrelationships of the nonsimple domains is a collection of trees.<br />
(2) No primary key has a component domain which is nonsimple.[2]</p>
</blockquote>

<h4 id="second-normal-form-2nf">Second Normal Form (2NF)</h4>

<blockquote>
  <p>Specifically: a relation is in 2NF if it is in 1NF and no non-prime attribute is dependent on any proper subset of any candidate key of the relation. A non-prime attribute of a relation is an attribute that is not a part of any candidate key of the relation.[3]</p>
</blockquote>

<h4 id="third-normal-form-3nf">Third Normal Form (3NF)</h4>

<blockquote>
  <p>all the attributes in a table are determined only by the candidate keys of that relation and not by any non-prime attributes.[4]</p>
</blockquote>

<p>An entity class should be mapped to one ore more relational tables. Entity may has attributes, simple type attribute should be mapped to single column, but complex type attribute may be mapped to extra tables.</p>

<h2 id="reference">Reference</h2>

<ol>
  <li><a href="https://en.wikibooks.org/wiki/Java_Persistence/Relationships">Java Persistence/Relationships</a></li>
  <li><a href="https://www.seas.upenn.edu/~zives/03f/cis550/codd.pdf">A Relational Model of Data for Large Shared Data Banks, E. F. Codd, IBM Research Laboratory, San Jose, California</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Second_normal_form">Second normal form</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Third_normal_form">Third normal form</a></li>
  <li><a href="https://jcp.org/aboutJava/communityprocess/final/jsr338/index.html">JSR 338: Java(TM) Persistence API, Version 2.1</a></li>
</ol>
